<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Native WebSocket Example</title>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script language="javascript" type="text/javascript">
		var wsUri = "wss://api.upbit.com/websocket/v1";
    var audio = new Audio('sound.MP3');
    var bird = new Audio('bird.MP3');

    let isReady = false;

    let volumePower = 0;
    let buyPerMinute = 0;
    let sellPerMinute = 0;
    let buyArr = [];
    let sellArr = [];

    let token = '';

    let nowAskPrice = 0;
    let nowBidPrice = 0;

    let myMoney = 100000000;
    let myCoin = 0;

    let limitPower = 0;

		function init(){
			testWebSocket();
      setTimeout(() => {
        isReady = true;
      }, 60000);
		}

		function testWebSocket(){
			websocket = new WebSocket(wsUri);
			websocket.binaryType = 'arraybuffer';

			websocket.onopen = function(evt) { onOpen(evt) ;};
			websocket.onmessage = function(evt) { onMessage(evt) };
			websocket.onerror = function(evt) { onError(evt) };
		}

		function onOpen(evt){
			writeToScreen("연결완료");
			var msg = [
        {
					"ticket"	: "TEST",
				},{
					"type"		: "trade",
					"codes"		: ["KRW-BTC"],
          "isOnlyRealtime": true,
				}, {
          'type': "orderbook",
					"codes"		: ["KRW-BTC"],
        }
			];
			msg = JSON.stringify(msg);
			doSend(msg);
		}

		function onClose()		{
			websocket.close();
      console.log('onClose');
		}
    function getTime() {
      const date = new Date();
      return date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds();
    }

		function onMessage(evt)		{
			var enc = new TextDecoder("utf-8");
			var arr = new Uint8Array(evt.data);
      let data = JSON.parse(enc.decode(arr));

      if (data.type === "orderbook") {
        nowAskPrice = data.orderbook_units[0].ask_price;
        nowBidPrice = data.orderbook_units[0].bid_price;
      } else if (data.type === 'trade') {
        // 체결 강도 = 매수량 / 매도량 * 100 
        if (data.ask_bid === 'BID') {
          // 1분 = 60000
          buyArr.push(data);
          buyArr = buyArr.filter(i => i.trade_timestamp > (data.trade_timestamp - 30000));
          buyPerMinute = buyArr.reduce((acc, cur, i) => {
            return acc + cur.trade_volume;
          }, 0);
          
        } else {
          sellArr.push(data);
          sellArr = sellArr.filter(i => i.trade_timestamp > (data.trade_timestamp - 30000));
          sellPerMinute = sellArr.reduce((acc, cur, i) => {
            return acc + cur.trade_volume;
          }, 0);
        }
        volumePower = buyPerMinute / sellPerMinute * 100;
      }
      if (data.type === 'trade') {
        if (myCoin > 0 && (volumePower < 400 || volumePower < limitPower - 200)) {
          console.log('팔자 현재가', comma(nowBidPrice), getTime(), comma(myMoney), volumePower);
          console.log('---------------')

          sellCoin();
          playBird();
        }
        if (!isReady) return;
        if (volumePower > 600 && myMoney > 0 && volumePower > limitPower) {
          if (myMoney > 0) {
            limitPower = volumePower;
            console.log('사자 현재가', comma(nowAskPrice), getTime(), comma(myMoney), volumePower);
            buyCoin();
            playAudio();
          }
        }
        writeToScreen('<span">비트코인 <br />구매: '+ buyPerMinute + '<br /> 판매: ' + sellPerMinute + '<br />체결강도: ' + volumePower  +'</span>');
      }
      
		}

		function onError(evt){
			writeToScreen('<span style="color: red;">에러:</span> ' + evt.data);
		}

		function doSend(message){
			websocket.send(message);
		}
    function playAudio() {
      audio.play();
      setTimeout(() => {
        audio.pause();
        audio.currentTime = 0;
      }, 2300);
    }
    function playBird() {
      bird.play();
      setTimeout(() => {
        bird.pause();
        bird.currentTime = 0;
      }, 2300);
    }

		function writeToScreen(message){
			const coin = document.getElementById('bitcoin');
			coin.innerHTML = message;
		}
		window.addEventListener("load", init, false);

    function comma(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function getMyMoney () {
      document.getElementById('myMoney').innerHTML = comma(myMoney);
    }
    function getMyCoin () {
      document.getElementById('myCoin').innerHTML = myCoin;
    }

    async function getToken() {
      const { data } = await axios.get('/token');
      token = data.token;
    }
    function buyCoin () {
      myCoin = myMoney / nowAskPrice;
      myMoney = 0;
      getMyMoney();
      getMyCoin();
    };
    function sellCoin () {
      myMoney =+ Math.floor((nowBidPrice * myCoin) * 0.9995);
      myCoin = 0;
      getMyMoney();
      getMyCoin();
    }
    
	</script>

  <h2>WebSocket Test</h2>
  <button onClick="onClose()">멈추기</button>
  <button onClick="getToken()">토큰받기</button>
  <button onClick="getMyMoney()">내 돈 확인하기</button>
  <br />
  내 돈:  <span id="myMoney"></span>
  내 코인:  <span id="myCoin"></span>
  <br />
  <!-- <button id="audio" onClick="audioPlay()">PLAY MY AUDIO</button> -->
  <div id="bitcoin">로딩중...</div>
</body>
</html>